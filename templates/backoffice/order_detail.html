{% extends "backoffice/base.html" %}
{% load humanize %}
{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ #{{ order.number }} | Backoffice{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">

    <!-- Header -->
    <div class="box mb-5">
      <div class="level">
        <div class="level-left">
          <h1 class="title is-5 mb-0">
            Ø³ÙØ§Ø±Ø´ <span class="has-text-primary">#{{ order.number }}</span>
          </h1>
          <span class="ml-3">
            {% include "backoffice/partials/_order_status_badge.html" with status=order.status %}
          </span>
        </div>
        <div class="level-right">
          <a class="button is-small is-light" href="{% url 'orders:list' %}">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a>
        </div>
      </div>

      <!-- Status form -->
      <form class="inline-status-form mt-3" action="{% url 'backoffice:set_status' order.id %}" method="post" data-order-id="{{ order.id }}">
        {% csrf_token %}
        <div class="field has-addons">
          <p class="control">
            <span class="select is-small">
              <select name="status">
                {% for key,label in order.STATUS_CHOICES %}
                  <option value="{{ key }}" {% if key == order.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </span>
          </p>
          <p class="control">
            <button type="submit" class="button is-small is-primary">Ø§Ø¹Ù…Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª</button>
          </p>
        </div>
      </form>
    </div>

    <div class="columns is-variable is-5">

      <!-- Left: Customer & Logs -->
      <div class="column is-5">
        <div class="box mb-5">
          <h2 class="title is-6 mb-3">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</h2>
          {% if order.user %}
            <p><strong>Ù†Ø§Ù…:</strong> {{ order.user.get_full_name|default:order.user.get_username }}</p>
            <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> {{ order.user.email|default:"â€”" }}</p>
          {% else %}
            <p>Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª <span class="tag is-light is-rounded">Ù…Ù‡Ù…Ø§Ù†</span></p>
          {% endif %}

          <hr>

          <h3 class="title is-6 mb-2">ğŸ“ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§</h3>
          <div class="columns is-mobile">
            <div class="column">
              <p class="has-text-weight-semibold">ØµÙˆØ±ØªØ­Ø³Ø§Ø¨</p>
              <p class="is-size-7 has-text-grey-light">{{ order.billing_address|default:"â€”" }}</p>
            </div>
            <div class="column">
              <p class="has-text-weight-semibold">Ø§Ø±Ø³Ø§Ù„</p>
              <p class="is-size-7 has-text-grey-light">{{ order.shipping_address|default:"â€”" }}</p>
            </div>
          </div>
        </div>

        {% if order.status_logs.all %}
        <div class="box">
          <h2 class="title is-6 mb-3">ğŸ•“ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</h2>
          <div class="table-container">
            <table class="table is-fullwidth is-narrow is-hoverable">
              <thead>
                <tr>
                  <th>Ø²Ù…Ø§Ù†</th>
                  <th>ØªØºÛŒÛŒØ±â€ŒØ¯Ù‡Ù†Ø¯Ù‡</th>
                  <th>Ø§Ø²</th>
                  <th>Ø¨Ù‡</th>
                  <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                </tr>
              </thead>
              <tbody>
                {% for log in order.status_logs.all %}
                <tr>
                  <td>{{ log.created_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ log.changed_by|get_full_name|default:log.changed_by|default:"â€”" }}</td>
                  <td>{{ log.from_status|default:"â€”" }}</td>
                  <td>{{ log.to_status|default:"â€”" }}</td>
                  <td>{{ log.note|default:"â€”" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Right: Items & Totals -->
      <div class="column is-7">
        <div class="box mb-5">
          <h2 class="title is-6 mb-3">ğŸ›’ Ø§Ù‚Ù„Ø§Ù… Ø³ÙØ§Ø±Ø´</h2>

          <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
              <thead>
                <tr>
                  <th>Ù…Ø­ØµÙˆÙ„</th>
                  <th class="has-text-centered">ØªØ¹Ø¯Ø§Ø¯</th>
                  <th class="has-text-right">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                  <th class="has-text-right">Ø¬Ù…Ø¹ Ø®Ø·</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items.all %}
                <tr>
                  <td>
                    {{ it.product.name }}
                    {% if it.variant %}
                      <span class="tag is-light is-rounded is-size-7">ØªÙ†ÙˆØ¹: {{ it.variant.sku|default:it.variant.id }}</span>
                    {% endif %}
                  </td>
                  <td class="has-text-centered">{{ it.quantity }}</td>
                  <td class="has-text-right">{{ it.unit_price|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                  <td class="has-text-right">{{ it.line_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="has-text-centered has-text-grey">Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="columns mt-4">
            <div class="column is-offset-6 is-6">
              <table class="table is-fullwidth is-narrow">
                <tbody>
                  <tr>
                    <th>Ø¬Ù…Ø¹ Ø¬Ø²Ø¡</th>
                    <td class="has-text-right">{{ order.subtotal|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                  </tr>
                  {% if order.discount_total %}
                  <tr>
                    <th>ØªØ®ÙÛŒÙ</th>
                    <td class="has-text-right has-text-danger">-{{ order.discount_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                  </tr>
                  {% endif %}
                  {% if order.shipping_total %}
                  <tr>
                    <th>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</th>
                    <td class="has-text-right">{{ order.shipping_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                  </tr>
                  {% endif %}
                  {% if order.tax_total %}
                  <tr>
                    <th>Ù…Ø§Ù„ÛŒØ§Øª</th>
                    <td class="has-text-right">{{ order.tax_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                  </tr>
                  {% endif %}
                  <tr class="has-background-dark">
                    <th class="has-text-white">Ù…Ø¨Ù„Øº Ú©Ù„</th>
                    <td class="has-text-right has-text-white"><strong>{{ order.grand_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.querySelector(".inline-status-form");
  if (!form) return;
  const select = form.querySelector("select[name='status']");
  if (select) {
    select.addEventListener("change", () => form.requestSubmit());
  }
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    const url = form.getAttribute("action");
    const data = new FormData(form);
    try {
      const res = await fetch(url, { method: "POST", headers: {"X-Requested-With":"XMLHttpRequest"}, body: data });
      if (!res.ok) throw new Error("Bad response");
      const payload = await res.json();
      if (payload.ok && payload.badge_html) {
        const badgeHolder = document.querySelector(".title + span");
        if (badgeHolder) badgeHolder.innerHTML = payload.badge_html;
      }
    } catch (err) {
      console.error(err);
      alert("ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.");
    }
  });
})();
</script>
{% endblock %}
