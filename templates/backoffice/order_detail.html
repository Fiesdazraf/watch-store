{% extends "backoffice/base.html" %}
{% load humanize %}
{% block title %}جزئیات سفارش #{{ order.number }} | Backoffice{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">

    <!-- Header -->
    <div class="box mb-5">
      <div class="level">
        <div class="level-left">
          <h1 class="title is-5 mb-0">
            سفارش <span class="has-text-primary">#{{ order.number }}</span>
          </h1>
          <span class="ml-3">
            {% include "backoffice/partials/_order_status_badge.html" with status=order.status %}
          </span>
        </div>
        <div class="level-right">
          <a class="button is-small is-light" href="{% url 'orders:list' %}">بازگشت به سفارش‌ها</a>
        </div>
      </div>

      <!-- Status form -->
      <form class="inline-status-form mt-3" action="{% url 'backoffice:set_status' order.id %}" method="post" data-order-id="{{ order.id }}">
        {% csrf_token %}
        <div class="field has-addons">
          <p class="control">
            <span class="select is-small">
              <select name="status">
                {% for key,label in order.STATUS_CHOICES %}
                  <option value="{{ key }}" {% if key == order.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </span>
          </p>
          <p class="control">
            <button type="submit" class="button is-small is-primary">اعمال وضعیت</button>
          </p>
        </div>
      </form>
    </div>

    <div class="columns is-variable is-5">

      <!-- Left: Customer & Logs -->
      <div class="column is-5">
        <div class="box mb-5">
          <h2 class="title is-6 mb-3">👤 اطلاعات مشتری</h2>
          {% if order.user %}
            <p><strong>نام:</strong> {{ order.user.get_full_name|default:order.user.get_username }}</p>
            <p><strong>ایمیل:</strong> {{ order.user.email|default:"—" }}</p>
          {% else %}
            <p>سفارش به صورت <span class="tag is-light is-rounded">مهمان</span></p>
          {% endif %}

          <hr>

          <h3 class="title is-6 mb-2">📍 آدرس‌ها</h3>
          <div class="columns is-mobile">
            <div class="column">
              <p class="has-text-weight-semibold">صورتحساب</p>
              <p class="is-size-7 has-text-grey-light">{{ order.billing_address|default:"—" }}</p>
            </div>
            <div class="column">
              <p class="has-text-weight-semibold">ارسال</p>
              <p class="is-size-7 has-text-grey-light">{{ order.shipping_address|default:"—" }}</p>
            </div>
          </div>
        </div>

        {% if order.status_logs.all %}
        <div class="box">
          <h2 class="title is-6 mb-3">🕓 تاریخچه تغییر وضعیت</h2>
          <div class="table-container">
            <table class="table is-fullwidth is-narrow is-hoverable">
              <thead>
                <tr>
                  <th>زمان</th>
                  <th>تغییر‌دهنده</th>
                  <th>از</th>
                  <th>به</th>
                  <th>یادداشت</th>
                </tr>
              </thead>
              <tbody>
                {% for log in order.status_logs.all %}
                <tr>
                  <td>{{ log.created_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ log.changed_by|get_full_name|default:log.changed_by|default:"—" }}</td>
                  <td>{{ log.from_status|default:"—" }}</td>
                  <td>{{ log.to_status|default:"—" }}</td>
                  <td>{{ log.note|default:"—" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Right: Items & Totals -->
      <div class="column is-7">
        <div class="box mb-5">
          <h2 class="title is-6 mb-3">🛒 اقلام سفارش</h2>

          <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
              <thead>
                <tr>
                  <th>محصول</th>
                  <th class="has-text-centered">تعداد</th>
                  <th class="has-text-right">قیمت واحد</th>
                  <th class="has-text-right">جمع خط</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items.all %}
                <tr>
                  <td>
                    {{ it.product.name }}
                    {% if it.variant %}
                      <span class="tag is-light is-rounded is-size-7">تنوع: {{ it.variant.sku|default:it.variant.id }}</span>
                    {% endif %}
                  </td>
                  <td class="has-text-centered">{{ it.quantity }}</td>
                  <td class="has-text-right">{{ it.unit_price|floatformat:0|intcomma }} تومان</td>
                  <td class="has-text-right">{{ it.line_total|floatformat:0|intcomma }} تومان</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="has-text-centered has-text-grey">آیتمی ثبت نشده است.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="columns mt-4">
            <div class="column is-offset-6 is-6">
              <table class="table is-fullwidth is-narrow">
                <tbody>
                  <tr>
                    <th>جمع جزء</th>
                    <td class="has-text-right">{{ order.subtotal|floatformat:0|intcomma }} تومان</td>
                  </tr>
                  {% if order.discount_total %}
                  <tr>
                    <th>تخفیف</th>
                    <td class="has-text-right has-text-danger">-{{ order.discount_total|floatformat:0|intcomma }} تومان</td>
                  </tr>
                  {% endif %}
                  {% if order.shipping_total %}
                  <tr>
                    <th>هزینه ارسال</th>
                    <td class="has-text-right">{{ order.shipping_total|floatformat:0|intcomma }} تومان</td>
                  </tr>
                  {% endif %}
                  {% if order.tax_total %}
                  <tr>
                    <th>مالیات</th>
                    <td class="has-text-right">{{ order.tax_total|floatformat:0|intcomma }} تومان</td>
                  </tr>
                  {% endif %}
                  <tr class="has-background-dark">
                    <th class="has-text-white">مبلغ کل</th>
                    <td class="has-text-right has-text-white"><strong>{{ order.grand_total|floatformat:0|intcomma }} تومان</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.querySelector(".inline-status-form");
  if (!form) return;
  const select = form.querySelector("select[name='status']");
  if (select) {
    select.addEventListener("change", () => form.requestSubmit());
  }
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    const url = form.getAttribute("action");
    const data = new FormData(form);
    try {
      const res = await fetch(url, { method: "POST", headers: {"X-Requested-With":"XMLHttpRequest"}, body: data });
      if (!res.ok) throw new Error("Bad response");
      const payload = await res.json();
      if (payload.ok && payload.badge_html) {
        const badgeHolder = document.querySelector(".title + span");
        if (badgeHolder) badgeHolder.innerHTML = payload.badge_html;
      }
    } catch (err) {
      console.error(err);
      alert("تغییر وضعیت با خطا مواجه شد.");
    }
  });
})();
</script>
{% endblock %}
