{% extends "backoffice/base.html" %}
{% load humanize %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ | Watch-Store{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">

    <h1 class="title is-4 mb-5">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h1>

    <!-- ğŸ”¹ Filters -->
    <form method="get" class="box mb-5">
      <div class="columns is-multiline">
        <div class="column is-one-quarter">
          <label class="label">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
          <input class="input" type="date" name="start" value="{{ kpi_filters.start|default_if_none:'' }}">
        </div>
        <div class="column is-one-quarter">
          <label class="label">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
          <input class="input" type="date" name="end" value="{{ kpi_filters.end|default_if_none:'' }}">
        </div>
        <div class="column is-one-quarter">
          <label class="label">ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´</label>
          <div class="select is-fullwidth">
            <select name="status">
              <option value="" {% if not kpi_filters.status %}selected{% endif %}>Ù‡Ù…Ù‡</option>
              <option value="pending" {% if kpi_filters.status == 'pending' %}selected{% endif %}>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="paid" {% if kpi_filters.status == 'paid' %}selected{% endif %}>Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</option>
              <option value="shipped" {% if kpi_filters.status == 'shipped' %}selected{% endif %}>Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡</option>
              <option value="completed" {% if kpi_filters.status == 'completed' %}selected{% endif %}>ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</option>
              <option value="canceled" {% if kpi_filters.status == 'canceled' %}selected{% endif %}>Ù„ØºÙˆâ€ŒØ´Ø¯Ù‡</option>
            </select>
          </div>
        </div>
        <div class="column is-one-quarter is-flex is-align-items-flex-end" style="gap:.5rem">
          <button class="button is-primary" type="submit">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
          <a class="button" href="{% url 'backoffice:dashboard' %}">Ø±ÛŒØ³Øª</a>
        </div>
      </div>
    </form>

    <!-- ğŸ”¹ KPI Summary -->
    <div class="columns is-multiline mb-5">
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">Ù…Ø¬Ù…ÙˆØ¹ ÙØ±ÙˆØ´</p>
          <p class="title is-4">
            {{ sales_kpis.total_revenue|floatformat:0|intcomma }}
            <span class="is-size-6 has-text-grey-light">ØªÙˆÙ…Ø§Ù†</span>
          </p>
        </div>
      </div>

      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</p>
          <p class="title is-4">{{ sales_kpis.total_orders|intcomma }}</p>
        </div>
      </div>

      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø±Ø²Ø´ Ø³ÙØ§Ø±Ø´</p>
          <p class="title is-4">
            {{ sales_kpis.avg_order_value|floatformat:0|intcomma }}
            <span class="is-size-6 has-text-grey-light">ØªÙˆÙ…Ø§Ù†</span>
          </p>
        </div>
      </div>

      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†</p>
          <p class="title is-4">{{ sales_kpis.total_customers|intcomma }}</p>
        </div>
      </div>
    </div>

    <!-- ğŸ”¹ Counters -->
    <div class="columns is-multiline mb-5">
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</p><p class="title is-4">{{ orders_counters.new|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</p><p class="title is-4">{{ orders_counters.processing|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</p><p class="title is-4">{{ orders_counters.completed|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯</p><p class="title is-4">{{ users_counters.new|intcomma }}</p></div></div>

      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p><p class="title is-4">{{ users_counters.total|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ú©Ù„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</p><p class="title is-4">{{ invoices_counters.total|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</p><p class="title is-4">{{ invoices_counters.paid|intcomma }}</p></div></div>
      <div class="column is-3"><div class="box has-text-centered"><p class="heading">Ø¬Ù…Ø¹ Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</p><p class="title is-4">{{ invoices_counters.total_amount|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</p></div></div>
    </div>

    <!-- ğŸ”¹ Sales trend -->
    <div class="box mb-5">
      <h2 class="title is-5 mb-3">ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± ÙØ±ÙˆØ´ Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±</h2>
      <div class="chart-wrap"><canvas id="salesChart"></canvas></div>
    </div>

    <!-- ğŸ”¹ Payment & Order charts -->
    <div class="columns mb-5">
      <div class="column">
        <div class="box">
          <h2 class="title is-6 mb-2">Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
          <div class="chart-wrap"><canvas id="paymentsBreakdownChart"></canvas></div>
        </div>
      </div>
      <div class="column">
        <div class="box">
          <h2 class="title is-6 mb-2">ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h2>
          <div class="chart-wrap"><canvas id="ordersStatusChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¹ Recent Invoices -->
    <div class="box mb-5">
      <div class="level mb-3">
        <div class="level-left">
          <h2 class="title is-5 mb-0">ğŸ§¾ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h2>
        </div>
        <div class="level-right">
          <a href="{% url 'backoffice:invoices_list' %}" class="button is-small is-light">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</a>
        </div>
      </div>

      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>Ø´Ù…Ø§Ø±Ù‡</th>
              <th>Ù…Ø¨Ù„Øº</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
              <th>ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±</th>
              <th>ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in recent_invoices %}
              <tr>
                <td><a href="{% url 'invoices:invoice_detail' inv.number %}" class="has-text-link">{{ inv.number }}</a></td>
                <td>{{ inv.amount|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                <td>
                  {% include "backoffice/partials/_order_status_badge.html" with status=inv.status %}
                </td>
                <td>{{ inv.issued_at|date:"Y-m-d H:i" }}</td>
                <td>{{ inv.paid_at|date:"Y-m-d H:i" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="has-text-centered">Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ğŸ”¹ Recent Orders -->
    <div class="box">
      <h2 class="title is-5 mb-3">ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h2>
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>Ø´Ù…Ø§Ø±Ù‡</th>
              <th>Ù…Ø´ØªØ±ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ®</th>
              <th>Ù…Ø¨Ù„Øº</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
            </tr>
          </thead>
          <tbody>
            {% for o in recent_orders %}
              <tr>
                <td><a href="{% url 'orders:detail' o.number %}" class="has-text-link">{{ o.number }}</a></td>
                <td>{{ o.customer }}</td>
                <td>{{ o.placed_at|date:"Y-m-d H:i" }}</td>
                <td>{{ o.grand_total|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
                <td>{% include "backoffice/partials/_order_status_badge.html" with status=o.status %}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="has-text-centered">Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  const KPI_FILTERS = {{ kpi_filters|default:"{}"|safe }};
  function makeURL(base) {
    const url = new URL(base, window.location.origin);
    for (const [k, v] of Object.entries(KPI_FILTERS)) if (v) url.searchParams.set(k, v);
    return url.toString();
  }
  fetch(makeURL("{{ sales_api_url }}"))
    .then(r => r.json())
    .then(data => {
      new Chart(document.getElementById('salesChart'), {
        type: 'line',
        data: { labels: data.labels || [], datasets: [
          { label: 'Ù…Ø¨Ù„Øº ÙØ±ÙˆØ´', data: data.amounts, tension: 0.3, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.2)' },
          { label: 'ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§', data: data.counts, tension: 0.3, borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,0.2)' }
        ]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e9edf5' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#9aa3b2' } }, x: { ticks: { color: '#9aa3b2' } } } }
      });
    });

  fetch(makeURL("{% url 'backoffice:payments_breakdown_api' %}"))
    .then(r => r.json())
    .then(data => new Chart(document.getElementById('paymentsBreakdownChart'), {
      type: 'doughnut', data,
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e9edf5' } } } }
    }));

  fetch(makeURL("{% url 'backoffice:orders_status_api' %}"))
    .then(r => r.json())
    .then(data => new Chart(document.getElementById('ordersStatusChart'), {
      type: 'bar', data,
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e9edf5' } } }, scales: { x: { ticks: { color: '#9aa3b2' } }, y: { ticks: { color: '#9aa3b2' } } } }
    }));
</script>

<style>
  .chart-wrap { position: relative; min-height: 300px; height: 340px; }
  @media (max-width: 768px) { .chart-wrap { height: 280px; } }
</style>
{% endblock %}
