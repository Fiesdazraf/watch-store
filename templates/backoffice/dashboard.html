{# templates/backoffice/dashboard.html #}
{% extends "backoffice/base.html" %}
{% load humanize %}
{% block title %}Dashboard{% endblock %}

{% block content %}

  <!-- KPIs (اختیاری) -->

  <!-- Recent Orders -->
  <div class="box mt-5">
    <div class="level">
      <div class="level-left">
        <h2 class="title is-5 mb-0">Recent Orders</h2>
      </div>
      <div class="level-right">
        <a class="button is-light is-small" href="{% url 'orders:list' %}">View all</a>
      </div>
    </div>

    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable" aria-label="Recent orders">
        <thead>
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Placed</th>
            <th class="has-text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for order in recent_orders %}
          <tr id="order-row-{{ order.id }}">
            <td><a href="{% url 'orders:detail' order.id %}">{{ order.number }}</a></td>

            {# 👇 همراستا با customer.user #}
            <td>
              {% if order.customer and order.customer.user %}
                {{ order.customer.user.get_full_name|default:order.customer.user.email }}
              {% else %}
                Guest
              {% endif %}
            </td>

            <td>
              {% for it in order.items.all|slice:":3" %}
                <span class="tag is-light mb-1">{{ it.product.name|truncatechars:24 }}</span>
              {% empty %}
                <span class="has-text-grey">—</span>
              {% endfor %}
            </td>

            <td>{{ order.grand_total|floatformat:2 }} {{ order.currency|default:"EUR" }}</td>

            <td>
              {% include "backoffice/partials/_order_status_badge.html" with status=order.status %}
            </td>

            <td>{{ order.placed_at|naturaltime }}</td>

            <td class="has-text-right">
              <!-- Change Status inline (POST -> set_status via AJAX) -->
              <form class="inline-status-form"
                    action="{% url 'backoffice:set_status' order.id %}"
                    method="post"
                    data-order-id="{{ order.id }}">
                {% csrf_token %}
                <div class="field has-addons is-inline-block">
                  <p class="control">
                    <span class="select is-small">
                      <select name="status" aria-label="Change status">
                        {# اگر STATUS_CHOICES در مدل بود، از خودش استفاده کن #}
                        {% if order.STATUS_CHOICES %}
                          {% for key,label in order.STATUS_CHOICES %}
                            <option value="{{ key }}" {% if key == order.status %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        {% else %}
                          {# در غیر این صورت یک fallback رایج و بی‌خطر #}
                          {% with fallback_statuses="pending,paid,processing,shipped,delivered,canceled"|split:"," %}
                            {% for key in fallback_statuses %}
                              <option value="{{ key }}" {% if key == order.status %}selected{% endif %}>
                                {{ key|capfirst }}
                              </option>
                            {% endfor %}
                          {% endwith %}
                        {% endif %}
                      </select>
                    </span>
                  </p>
                  <p class="control">
                    <button type="submit" class="button is-small is-primary">Set</button>
                  </p>
                </div>
              </form>

              <a class="button is-small is-white" href="{% url 'orders:detail' order.id %}">Details</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="has-text-centered has-text-grey">No recent orders.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sales Chart -->
  <div class="box mt-5">
    <div class="level">
      <div class="level-left">
        <h2 class="title is-5 mb-0">Sales (Last 30 days)</h2>
      </div>
    </div>
    <div style="height: 260px;">
      <canvas id="salesChart"
              role="img"
              aria-label="Sales line chart"
              data-sales-url="{% url 'backoffice:sales_api' %}"></canvas>
    </div>
    <p class="help">If the chart is empty, ensure Chart.js is loaded and the API returns labels &amp; datasets.</p>
  </div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-submit on change to reduce clicks
document.querySelectorAll(".inline-status-form select[name='status']").forEach(function(sel){
  sel.addEventListener("change", function(){
    this.form.requestSubmit();
  });
});

// Inline status change (POST to set_status) with small UX niceties
document.querySelectorAll(".inline-status-form").forEach(function(form){
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    const orderId = form.dataset.orderId;
    const url = form.getAttribute("action");
    const formData = new FormData(form);

    const btn = form.querySelector("button[type='submit']");
    if (btn) btn.disabled = true;

    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData
      });
      if (!resp.ok) throw new Error("Request failed");

      const data = await resp.json(); // {ok: true, status: "...", badge_html: "..."}
      if (data.ok) {
        const row = document.getElementById(`order-row-${orderId}`);
        const badgeCell = row.querySelector("td:nth-child(5)");
        if (data.badge_html) {
          badgeCell.innerHTML = data.badge_html;
        }
        row.classList.add("has-background-success-light");
        setTimeout(()=>row.classList.remove("has-background-success-light"), 1200);
      }
    } catch (err) {
      console.error(err);
      alert("Failed to change status.");
    } finally {
      if (btn) btn.disabled = false;
    }
  });
});

// Sales chart hookup (Chart.js)
(async function(){
  const el = document.getElementById("salesChart");
  if (!el || typeof Chart === "undefined") return;
  const url = el.dataset.salesUrl;

  try {
    const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
    if (!resp.ok) throw new Error("Chart API failed");
    const payload = await resp.json();

    new Chart(el.getContext("2d"), {
      type: "line",
      data: {
        labels: payload.labels || [],
        datasets: (payload.datasets || []).map(ds => ({
          ...ds,
          tension: 0.35,
          fill: false,
          pointRadius: 2,
        })),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: true } }
      }
    });
  } catch (e) {
    console.error(e);
  }
})();
</script>
{% endblock %}
