{% extends "backoffice/base.html" %}
{% load humanize %}
{{ value|intcomma }}

{% block title %}داشبورد{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">

    <h1 class="title is-4">داشبورد مدیریتی</h1>

    <!-- KPIs -->
    <div class="columns is-multiline">
      <!-- Sales KPIs -->
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">مجموع فروش</p>
          <p class="title is-4">
            {{ sales_kpis.total_revenue|floatformat:0|intcomma }}
          </p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">تعداد سفارش‌ها</p>
          <p class="title is-4">{{ sales_kpis.total_orders|intcomma }}</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">میانگین ارزش سفارش</p>
          <p class="title is-4">{{ sales_kpis.avg_order_value|floatformat:0|intcomma }}</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">تعداد مشتریان</p>
          <p class="title is-4">{{ sales_kpis.total_customers|intcomma }}</p>
        </div>
      </div>

      <!-- Orders counters -->
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">سفارش‌های جدید</p>
          <p class="title is-4">{{ orders_counters.new|intcomma }}</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">سفارش‌های در حال پردازش</p>
          <p class="title is-4">{{ orders_counters.processing|intcomma }}</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">سفارش‌های تکمیل‌شده</p>
          <p class="title is-4">{{ orders_counters.completed|intcomma }}</p>
        </div>
      </div>

      <!-- Users counters -->
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">کاربران جدید</p>
          <p class="title is-4">{{ users_counters.new|intcomma }}</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="heading">کل کاربران</p>
          <p class="title is-4">{{ users_counters.total|intcomma }}</p>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="box">
      <div class="level">
        <div class="level-left">
          <h2 class="title is-5 mb-0">نمودار فروش ۳۰ روز اخیر</h2>
        </div>
      </div>
      <canvas id="salesChart" height="120"></canvas>
    </div>

    <!-- Recent Orders -->
    <div class="box">
      <div class="level">
        <div class="level-left">
          <h2 class="title is-5 mb-0">سفارش‌های اخیر</h2>
        </div>
      </div>
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>شماره</th>
              <th>مشتری</th>
              <th>تاریخ</th>
              <th>مبلغ</th>
              <th>وضعیت</th>
            </tr>
          </thead>
          <tbody>
            {% for o in recent_orders %}
              <tr>
                <td>{{ o.number }}</td>
                <td>{{ o.customer }}</td>
                <td>{{ o.placed_at|date:"Y-m-d H:i" }}</td>
                <td>{{ o.grand_total|floatformat:0|intcomma }}</td>
                <td>{{ o.get_status_display }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="has-text-centered">سفارشی یافت نشد.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    fetch("{{ sales_api_url }}")
      .then(resp => resp.json())
      .then(data => {
        const ctx = document.getElementById('salesChart');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [
              { label: 'مبلغ فروش', data: data.amounts, tension: 0.3, borderColor: '#3273dc' },
              { label: 'تعداد سفارش', data: data.counts, tension: 0.3, borderColor: '#23d160' }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true },
              tooltip: { enabled: true }
            },
            scales: { y: { beginAtZero: true } }
          }
        });
      });
  </script>
{% endblock %}
