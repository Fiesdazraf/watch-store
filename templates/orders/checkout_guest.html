{% extends "base.html" %}
{% load static humanize %}
{% block title %}تسویه‌حساب مهمان | فروشگاه ساعت{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">
    <h1 class="title is-4 mb-5">🧾 تسویه‌حساب مهمان</h1>

    {% if items %}
    <div class="columns is-variable is-6">
      
      <!-- 🛍 Cart Summary -->
      <div class="column is-5">
        <div class="box">
          <h2 class="title is-5 mb-4">خلاصه سبد خرید</h2>

          <table class="table is-fullwidth is-striped is-narrow">
            <thead>
              <tr>
                <th>محصول</th>
                <th class="has-text-centered">تعداد</th>
                <th class="has-text-right">قیمت</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td>
                  <div class="is-flex is-align-items-center">
                    {% if it.product.primary_image %}
                      <figure class="image is-48x48 ml-3">
                        <img src="{{ it.product.primary_image.url }}" alt="{{ it.product.title }}">
                      </figure>
                    {% endif %}
                    <div>
                      <strong>{{ it.product.title }}</strong>
                      {% if it.variant_display %}
                        <div class="is-size-7 has-text-grey">({{ it.variant_display }})</div>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td class="has-text-centered">{{ it.quantity }}</td>
                <td class="has-text-right">{{ it.subtotal|intcomma }} تومان</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <hr class="my-3">

          <div class="is-flex is-justify-content-space-between mb-2">
            <span>جمع جزء:</span>
            <strong>{{ subtotal|intcomma }} تومان</strong>
          </div>

          {% if shipping_cost %}
          <div class="is-flex is-justify-content-space-between mb-2">
            <span>هزینه ارسال:</span>
            <strong>{{ shipping_cost|intcomma }} تومان</strong>
          </div>
          {% endif %}

          {% if discount_total %}
          <div class="is-flex is-justify-content-space-between mb-2 has-text-danger">
            <span>تخفیف:</span>
            <strong>-{{ discount_total|intcomma }} تومان</strong>
          </div>
          {% endif %}

          <hr class="my-2">
          <div class="is-flex is-justify-content-space-between">
            <span>مبلغ نهایی:</span>
            <strong class="has-text-weight-bold has-text-primary">{{ total|intcomma }} تومان</strong>
          </div>
        </div>
      </div>

      <!-- 📬 Guest Form -->
      <div class="column is-7">
        <div class="box">
          <h2 class="title is-5 mb-4">اطلاعات ارسال سفارش</h2>
          <form method="post" novalidate>
            {% csrf_token %}

            <!-- Full name -->
            <div class="field">
              <label class="label">نام و نام خانوادگی</label>
              <div class="control has-icons-left">
                {{ form.full_name }}
                <span class="icon is-small is-left"><i class="fas fa-user"></i></span>
              </div>
              {% for e in form.full_name.errors %}
                <p class="help is-danger">{{ e }}</p>
              {% endfor %}
            </div>

            <!-- Phone -->
            <div class="field">
              <label class="label">شماره تماس</label>
              <div class="control has-icons-left">
                {{ form.phone }}
                <span class="icon is-small is-left"><i class="fas fa-phone"></i></span>
              </div>
              {% for e in form.phone.errors %}
                <p class="help is-danger">{{ e }}</p>
              {% endfor %}
            </div>

            <!-- Address lines -->
            <div class="field">
              <label class="label">آدرس</label>
              <div class="control">{{ form.line1 }}</div>
              {% for e in form.line1.errors %}
                <p class="help is-danger">{{ e }}</p>
              {% endfor %}
            </div>

            <div class="field">
              <div class="control">{{ form.line2 }}</div>
              {% for e in form.line2.errors %}
                <p class="help is-danger">{{ e }}</p>
              {% endfor %}
            </div>

            <!-- City / Province -->
            <div class="columns">
              <div class="column">
                <div class="field">
                  <label class="label">شهر</label>
                  <div class="control">{{ form.city }}</div>
                </div>
              </div>
              <div class="column">
                <div class="field">
                  <label class="label">استان</label>
                  <div class="control">{{ form.province }}</div>
                </div>
              </div>
            </div>

            <!-- Postal code / Country -->
            <div class="columns">
              <div class="column">
                <div class="field">
                  <label class="label">کد پستی</label>
                  <div class="control">{{ form.postal_code }}</div>
                </div>
              </div>
              <div class="column">
                <div class="field">
                  <label class="label">کشور</label>
                  <div class="control">{{ form.country }}</div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="field">
              <label class="label">یادداشت (اختیاری)</label>
              <div class="control">
                <textarea name="notes" class="textarea" placeholder="در صورت نیاز توضیحات خود را وارد کنید..."></textarea>
              </div>
            </div>

            <!-- Submit -->
            <div class="field mt-5">
              <div class="control">
                <button class="button is-primary is-fullwidth is-medium" type="submit">
                  <span class="icon"><i class="fas fa-check"></i></span>
                  <span>ثبت و ادامه پرداخت</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% else %}
      <div class="notification is-warning has-text-centered py-6">
        <p class="is-size-5 mb-3">سبد خرید شما خالی است 😕</p>
        <a href="{% url 'catalog:product_list' %}" class="button is-link is-light">بازگشت به فروشگاه</a>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
