{% extends 'shop/base.html' %}

{% block title %}My Orders{% endblock %}

{% block content %}
<section class="section">
  <div class="container">
    <h1 class="title">My Orders</h1>

    {% if orders and orders.object_list %}
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>Number</th>
            <th>Status</th>
            <th>Total</th>
            <th>Placed</th>
            <th class="has-text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
          {% with p=o.payment_obj %}
          <tr>
            <td>
              <a href="{% url 'orders:detail' o.number %}">
                <strong>{{ o.number }}</strong>
              </a>
              {% if p and p.method %}
                <span class="tag is-light is-rounded is-size-7 ml-2">{{ p.method.name|default:"-" }}</span>
              {% endif %}
            </td>

            <td>
              {% if o.is_paid %}
                <span class="tag is-success">Paid</span>
              {% elif p and p.status == "failed" %}
                <span class="tag is-danger">Payment Failed</span>
              {% else %}
                <span class="tag is-warning">Awaiting Payment</span>
              {% endif %}
            </td>

            <td>{{ o.grand_total }}</td>
            <td>{{ o.placed_at|date:"Y-m-d H:i" }}</td>

            <td class="has-text-right">
              <a class="button is-small is-link" href="{% url 'orders:detail' o.number %}">
                View
              </a>
              {% if not o.is_paid %}
              <a class="button is-small is-primary ml-1" href="{{ o.get_checkout_payment_url }}">
                Pay / Retry
              </a>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
          {% endfor %}
        </tbody>
      </table>

      {% if orders.has_other_pages %}
      <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        {% if orders.has_previous %}
          <a class="pagination-previous" href="?page={{ orders.previous_page_number }}">Previous</a>
        {% endif %}
        {% if orders.has_next %}
          <a class="pagination-next" href="?page={{ orders.next_page_number }}">Next page</a>
        {% endif %}
        <ul class="pagination-list">
          {% for i in orders.paginator.page_range %}
            {% if i == orders.number %}
              <li><a class="pagination-link is-current">{{ i }}</a></li>
            {% else %}
              <li><a class="pagination-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
      </nav>
      {% endif %}
    {% else %}
      <div class="notification is-info">No orders yet.</div>
    {% endif %}
  </div>
</section>
{% endblock %}
