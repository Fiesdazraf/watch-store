{% extends "base.html" %}
{% block title %}سفارش {{ order.number }}{% endblock %}

{% block content %}
<section class="section pt-5">
  <div class="container">

    <h1 class="title is-4">سفارش {{ order.number }}</h1>

    <!-- Meta -->
    <div class="columns">
      <div class="column">
        <div class="box">
          <div class="columns is-multiline is-variable is-2">
            <div class="column is-half">
              <p><strong>تاریخ:</strong> {{ order.placed_at|date:"Y-m-d H:i" }}</p>
            </div>
            <div class="column is-half">
              <p>
                <strong>وضعیت سفارش:</strong>
                {% if order.is_paid %}
                  <span class="tag is-success">پرداخت شد</span>
                {% else %}
                  <span class="tag is-warning">در انتظار پرداخت</span>
                {% endif %}
              </p>
            </div>
            <div class="column is-half">
              <p><strong>مبلغ کل:</strong> {{ order.grand_total }} تومان</p>
            </div>
            <div class="column is-half">
              <p><strong>روش ارسال:</strong> {{ order.shipping_method.name }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Summary -->
    <div class="box">
      <h2 class="title is-5 mb-3">وضعیت پرداخت</h2>

      {% with p=order.payment_obj %}
        {% if p %}
          <p><strong>روش پرداخت:</strong> {{ p.method.name|default:"-" }}</p>
          <p><strong>وضعیت پرداخت:</strong>
            {% if p.status == "paid" %}
              <span class="tag is-success">موفق</span>
            {% elif p.status == "failed" %}
              <span class="tag is-danger">ناموفق</span>
            {% else %}
              <span class="tag is-warning">در انتظار</span>
            {% endif %}
          </p>
          {% if p.transaction_id %}
            <p><strong>کد تراکنش:</strong> <code>{{ p.transaction_id }}</code></p>
          {% endif %}
        {% else %}
          <p class="has-text-grey">برای این سفارش هنوز رکورد پرداخت ثبت نشده است.</p>
        {% endif %}
      {% endwith %}

      <div class="mt-4">
        {% if not order.is_paid %}
          <a class="button is-primary" href="{{ order.get_checkout_payment_url }}">پرداخت / تلاش مجدد</a>
        {% else %}
          <a class="button is-light" href="{% url 'orders:list' %}">بازگشت به سفارش‌ها</a>
        {% endif %}
      </div>
    </div>

    <!-- Items -->
    <div class="box">
      <h2 class="title is-5 mb-3">آیتم‌های سفارش</h2>
      <table class="table is-fullwidth">
        <thead>
          <tr>
            <th>محصول</th>
            <th>تنوع</th>
            <th>تعداد</th>
            <th>قیمت واحد</th>
            <th>مجموع</th>
          </tr>
        </thead>
        <tbody>
          {% for item in order.items.all %}
            <tr>
              <td>{{ item.product.name }}</td>
              <td>{{ item.variant|default:"-" }}</td>
              <td>{{ item.qty }}</td>
              <td>{{ item.unit_price }}</td>
              <td>{{ item.get_total }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="is-flex is-justify-content-flex-end">
        <div class="content">
          <p><strong>جمع جزء:</strong> {{ order.subtotal }}</p>
          <p><strong>هزینه ارسال:</strong> {{ order.shipping_cost }}</p>
          <p><strong>تخفیف:</strong> {{ order.discount_total }}</p>
          <p class="is-size-5"><strong>قابل پرداخت:</strong> {{ order.total_payable }}</p>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}
