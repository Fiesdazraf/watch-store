{%  "backoffice/base.html" %}
{% load humanize %}
{% block title %}Reports{% endblock %}

{% block content %}
<h2 class="title is-5">Sales Reports</h2>

<form method="get" class="box mb-5">
  <div class="columns is-vcentered">
    <div class="column is-one-quarter">
      <label class="label">Start</label>
      <input class="input" type="date" name="start" value="{{ start }}">
    </div>
    <div class="column is-one-quarter">
      <label class="label">End</label>
      <input class="input" type="date" name="end" value="{{ end }}">
    </div>
    <div class="column">
      <label class="label is-invisible">Submit</label>
      <button class="button is-link" type="submit">Apply</button>
      <a class="button is-light"
         href="{% url 'backoffice:reports_export_csv' %}?start={{ start }}&end={{ end }}">
        Export CSV
      </a>
    </div>
  </div>
</form>

{{ series|json_script:"sales-series" }}

<div class="box">
  <canvas id="salesChart" height="120"></canvas>
  <p class="mt-4">
    <strong>Total:</strong> {{ total_sum|floatformat:0|intcomma }}
  </p>
</div>

<div class="box">
  <h3 class="title is-6">Daily Breakdown</h3>
  <table class="table is-fullwidth is-striped is-hoverable">
    <thead>
      <tr>
        <th>Date</th>
        <th class="has-text-right">Sales</th>
      </tr>
    </thead>
    <tbody>
      {% for p in series %}
      <tr>
        <td>{{ p.label }}</td>
        <td class="has-text-right">{{ p.value|floatformat:0|intcomma }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="2">No data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('salesChart').getContext('2d');
  const series = JSON.parse(document.getElementById('sales-series').textContent);
  const labels = series.map(p => p.label);
  const data = series.map(p => p.value);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'Sales', data, fill: false, tension: 0.2, pointRadius: 2 }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        y: { beginAtZero: true },
        x: { ticks: { autoSkip: true, maxTicksLimit: 12 } }
      }
    }
  });
</script>
{% endblock %}
